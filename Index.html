<!DOCTYPE html>
<html ng-app="mobApp" lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <script src="./jquery.js"></script>
    <script src="./angular-1.5.3/angular.min.js"></script>
    <script src="./angular-1.5.3/angular-route.min.js"></script>
    <script src="./angular-1.5.3/angular-animate.min.js"></script>
    <!-- <script src="https://cdn.staticfile.net/angular.js/1.5.3/angular.min.js"></script> -->
    <!-- <script src="https://cdn.staticfile.net/angular.js/1.5.3/angular-route.min.js"></script> -->
    <link rel="stylesheet" href="prism/prism.css">
    <script type="text/javascript" src="decimal/decimal.js" data-manual></script>
    <script type="text/javascript" src="floatingui/floating-core-1.6.0.js"></script>
    <script type="text/javascript" src="floatingui/floating-ui-1.6.3.js"></script>
    <script type="text/javascript" src="prism/prism.js" data-manual></script>
    <link rel="stylesheet" href="./css/router-view.css">
    <link rel="stylesheet" href="./css/mob.css">
    <link rel="stylesheet" href="./css/mob-doc.css">
    <link rel="stylesheet" href="./css/mob-popper.css">
    <link rel="stylesheet" href="./css/mob-input.css">
    <link rel="stylesheet" href="./css/mob-input-number.css">
    <link rel="stylesheet" href="./css/mob-select.css">
    <link rel="stylesheet" href="./css/mob-select-options.css">
    <link rel="stylesheet" href="./css/mob-radio.css">
    <link rel="stylesheet" href="./css/mob-radio-button.css">
    <link rel="stylesheet" href="./css/mob-radio-group.css">
    <link rel="stylesheet" href="./css/mob-checkbox.css">
    >
    <link rel="stylesheet" href="./css/mob-checkbox-button.css">
    <link rel="stylesheet" href="./css/mob-checkbox-group.css">
    <link rel="stylesheet" href="./css/mob-divider.css">
</head>
<style>
    .contain {
        display: flex;
    }

    .navigation {
        position: fixed;
        padding: 20px 20px 0 0;
        width: 240px;
        height: 100%;
        background-color: #ffffff;
        margin-right: 20px;
        box-sizing: border-box;
        z-index: 1;
    }

    .navigation .nav-item {
        padding-left: 20px;
        height: 40px;
    }

    .navigation .nav-item a {
        display: flex;
        box-sizing: border-box;
        padding: 5px 20px;
        width: 100%;
        height: 40px;
        color: #444;
        align-items: center;
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
        font-weight: 400;
        text-decoration: none;
        transition: all var(--mob-transition-duration);
        border-radius: 8px;
    }

    .navigation .nav-item a:hover {
        color: var(--mob-active-text-color);
    }

    .navigation .nav-item.is_active a {
        background-color: var(--mob-active-text-color-light);
        color: var(--mob-active-text-color);
    }
</style>

<body ng-controller="IndexCtrl as ctrl">
<!-- <div>
    <p>最外面的</p>
    {{ctrl.form}}
    <br>
    ------
    <div style="width: 200px;">
        <mob-form form-item="ctrl.formItem" model="ctrl.form"></mob-form>
    </div>
</div> -->
<div class="contain" style="display: flex;">

    <div class="navigation" style="z-index: 1">
        <!-- <a href="#!/home">Home</a> -->
        <div class="nav-item" ng-class="{'is_active':item.path === routPath}" ng-repeat="item in menuList">
            <a href="{{'#' + item.path}}" ng-bind="item.label">home</a>
        </div>
    </div>

    <div style="z-index: 2">
        <div ng-view="" class="view-animate-container">
        </div>
    </div>
</div>

<script type="text/ng-template" id="home">
    <h1 style="margin-top:20px"> 参考Element UI ，基于Angular1.5.3开发的UI框架 </h1>
    <ul>
        <li>目前的插件都是直接操作<code>dom</code>的，并没有使用<code>Angular</code>的双向数据绑定机制，采用数据驱动的方式实现；经常出现下拉框、多选框，点击保存后，在新增，还是会显示上一步操作的内容
        </li>
    </ul>
</script>

</body>
<script>
    const BOOLEAN_CUSTOM_ATTR = new Set();
    angular.forEach("clearable,showPassword".split(","), function (value) {
        BOOLEAN_CUSTOM_ATTR.add(value)
    })
    const app = angular.module('mobApp', ['ngRoute', 'ngAnimate'])
    // .value('$routerRootComponent', 'mobApp')
    app.config(['$logProvider', '$routeProvider', function ($logProvider, $routeProvider) {
        // $logProvider.debugEnabled(true)

        $routeProvider
            .when('/home', {
                templateUrl: 'home',
                controller: 'IndexCtrl'
            })
            .when('/inputNumber', {
                templateUrl: './inputNumber.html',
                controller: 'InputNumberCtrl'
            })
            .when('/input', {
                templateUrl: './input.html',
                controller: 'InputCtrl'
            })
            .when('/radio', {
                templateUrl: './radio.html',
                controller: 'RadioCtrl'
            })
            .when('/checkBox', {
                templateUrl: './checkbox.html',
                controller: 'CheckBoxCtrl'
            })
            .when('/popper', {
                templateUrl: './popper.html',
                controller: 'PopperCtrl',
                controllerAs: 'home',
            })

            .when('/select', {
                templateUrl: './select.html',
                controller: 'SelectCtrl',
            })
            .otherwise({redirectTo: '/home'})
    }]);
    app.run(['$rootScope', '$log', '$animate', function ($rootScope, $log, $animate) {
        let ngViewAnimation = {
            enter: function (element, done) {
                $animate.animate(element, {
                    event: 'enter',
                    structural: true
                }).then(done);
            },
            leave: function (element, done) {
                $animate.animate(element, {
                    event: 'leave',
                    structural: true
                }).then(done);
            }
        };

        $rootScope.menuList = [
            {label: 'Home', path: '/home'},
            {label: 'popper容器', path: '/popper'},
            {label: 'Input输入框', path: '/input'},
            {label: 'Input Number 输入框', path: '/inputNumber'},
            {label: 'Radio单选框', path: '/radio'},
            {label: 'CheckBox多选框', path: '/checkBox'},
            {label: 'Select选择器', path: '/select'},
        ]
        //通过$on为$rootScope添加路由事件
        $rootScope.$on('$routeChangeSuccess', function (event, current, previous) {
            // $log.debug('successfully changed routes');
            // console.log('1')

            $rootScope.routPath = current.$$route.originalPath
            // $log.debug(event);
            // $log.debug(current);
            // $log.debug(previous);

            $animate.on('ngView', ngViewAnimation);
        });

        $rootScope.$on('$routeChangeError', function (event, current, previous, rejection) {
            $log.debug('error changing routes');
            // $log.debug(event);
            // $log.debug(current);
            // $log.debug(previous);
            // $log.debug(rejection);
        });
    }])
    ;

    app
        .controller('IndexCtrl', ['$route', function IndexCtrl($route) {
            // console.log($route)
            this.hero = {
                name: 'Spawn'
            };
            this.form = {};
            this.formItem = [
                {type: 'input', label: 'clearableInput', prop: 'clearableInput', options: {clearable: true}},
                {type: 'input', label: 'disableInput', prop: 'disableInput', options: {disable: true}},
                {type: 'input', label: 'showPasswordInput', prop: 'showPasswordInput', options: {showPassword: true}},
                {
                    type: 'select',
                    label: '名称1',
                    prop: 'name2',
                    options: {
                        clearable: true,
                        dataDic: [{label: 'Option1', value: 'Option1'}, {label: 'Option2', value: 'Option2'}]
                    }
                },
            ];
        }])
        .controller('InputCtrl', ['$scope', function IndexCtrl($scope) {
        }])
        .controller('RadioCtrl', ['$scope', function RadioCtrl($scope) {

            this.radioIndex = -1;
            this.radioGroupModel = '';
            this.radioGroup = [
                {label: '北京', value: '北京'},
                {label: '上海', value: '上海'},
                {label: '广州', value: '广州'}
            ]

            this.changeRadioGroupModel = function () {
                this.radioIndex = this.radioIndex + 1;
                if (this.radioIndex > this.radioGroup.length - 1) {
                    this.radioIndex = 0;
                }
                this.radioGroupModel = this.radioGroup[this.radioIndex].value
            }
            this.demo = 'Options1'
            this.fatherChange = function (value) {
                console.log('radio change回调方法', value)
            }
        }])
        .controller('CheckBoxCtrl', ['$scope', function CheckBoxCtrl($scope) {
            this.fatherChange = function (value) {
                console.log('radio change回调方法', value)
            }
        }])
        .controller('MultipleCheckBoxGroupCtrl', ['$scope', function MultipleCheckBoxGroupCtrl($scope) {
            this.multipleCheckBoxGroup = ['Option5']


            this.checkAll = false;
            this.indeterminate = true
            this.checkedCities = ['澳门', '上海'];
            this.changeTag = true;
            this.cities = ['北京', '上海', '广东', '深圳', '香港', '澳门']

            this.checkAllChange = function () {
                // 是否全选
                this.checkAll = !this.checkAll
                // 无实际应用，仅仅是为了告诉group，需要发送事件通知子组件
                this.changeTag = !this.changeTag
                // 赋值
                this.checkedCities = this.checkAll ? [...this.cities] : []
            }


            this.checkboxChangeHandle = function () {
                let checkCount = this.checkedCities.length
                this.checkAll = checkCount === this.cities.length
                this.indeterminate = checkCount > 0 && checkCount < this.cities.length
            }

            this.min = 2
            this.changeMin = function () {
                this.min = this.min + 1
            }
        }])
        .controller('InputNumberCtrl', ['$scope', function InputNumberCtrl($scope) {
            this.value = 1

            this.value2 = 2

            this.value3 = 2.5

            this.value4 = 3.5
        }])
        .controller('PopperCtrl', ['$scope', 'floating', 'uuId', function CheckBoxCtrl($scope, floating, uuId) {
            var vm = this;
            this.message = 'Welcome to School Buddy!';
            console.log($scope.$id)


            //
            // const { width: targetWidth } = button.getBoundingClientRect()
            // popper.style.minWidth = targetWidth +'px';
            //
            //
            // vm.autoUpdate = function(){
            //     // window.FloatingUIDOM.autoUpdate(button, popper, ()=>{
            //     //     vm.updatePosition()
            //     // })
            // }
            //
            // // this.updatePosition = function () {
            // vm.updatePosition = function(autoUpdate) {
            //         window.FloatingUIDOM.computePosition(button, popper, {
            //                 placement: 'bottom-start',
            //                 middleware: [
            //                     window.FloatingUIDOM.flip(),// y轴自适应
            //                     // window.FloatingUIDOM.flip(5),// y轴自适应 添加与边缘的空隙
            //                     window.FloatingUIDOM.shift(), // x轴自适应
            //                     // window.FloatingUIDOM.shift(5), // x轴自适应 添加与边缘的空隙
            //                     window.FloatingUIDOM.offset(5), // 与目标组件的  空隙
            //                     window.FloatingUIDOM.arrow({element: arrowElement}), // 箭头
            //
            //                 ]
            //             }
            //         ).then(({x, y, placement, middlewareData}) => {
            //             console.log(x, y)
            //             Object.assign(popper.style, {
            //                 left: `${x}px`,
            //                 top: `${y}px`,
            //             });
            //
            //             const {x: arrowX, y: arrowY} = middlewareData.arrow;
            //
            //             debugger
            //             const staticSide = {
            //                 top: 'bottom',
            //                 right: 'left',
            //                 bottom: 'top',
            //                 left: 'right',
            //             }[placement.split('-')[0]];
            //
            //             Object.assign(arrowElement.style, {
            //                 left: arrowX != null ? `${arrowX}px` : '',
            //                 // top: arrowY != null ? `${arrowY}px` : '',
            //                 right: '',
            //                 bottom: '',
            //                 [staticSide]: '-4px',
            //                 top:'0px'
            //             });
            //
            //
            //             popper.style.height = 'auto';
            //             const {height} = popper.getBoundingClientRect()
            //
            //             popper.style.height = 0;
            //             //offsetHeight会强制浏览器重绘(先渲染0px，然后再渲染heigt，如果不加则直接会渲染height，不会渲染0px)
            //             popper.offsetHeight
            //             popper.style.height = height + 'px';
            //
            //
            //             if (autoUpdate) {
            //                 setTimeout(function (){
            //                     vm.autoUpdate()
            //                 }, 500)
            //             }
            //         });
            // }
            //
            // this.show = false
            //
            // console.log(1)
            //
            // this.showOrHideTooltip = function (e) {
            //     console.log('我被点击了')
            //     this.show = !this.show
            //     if (this.show) {
            //         popper.style.display = 'block';
            //         vm.updatePosition(true);
            //     } else {
            //         // popper.remove()
            //         popper.style.height = '0';
            //         setTimeout(function () {
            //             popper.style.display = '';
            //         }, 300)
            //     }
            // }

        }])
        .controller('SelectCtrl', ['$scope', function InputNumberCtrl($scope) {

        }])
    ;
    app
        .directive('prism', function () {
            return {
                restrict: 'A',
                compile: function () {
                    return function (scope, element) {

                        Prism.highlightElement(element[0], false)
                    }
                },
                controller: function ($scope, $element) {
                }
            };
        })
        .directive('popper', ['uuId', 'floating', function (uuId, floating) {
            return {
                restrict: 'A',
                // transclude:true,
                // templateUrl:'./components/mob-popper.html',
                // replace:true,
                compile: function () {
                    return {
                        post: function (scope, element, attr) {
                            const target = element[0].querySelector('.mob_popper__target');
                            if (null == target) {
                                console.warn('target元素不存在')
                                return;
                            }
                            const floatingDom = element[0].querySelector('.mob-popper');
                            if (null == floatingDom) {
                                console.warn('target元素不存在')
                                return;
                            }
                            // 给浮动元素 生成唯一id
                            floatingDom.id = uuId.generate()
                            // 给目标元素绑定唯一id
                            target.setAttribute('popper-id', floatingDom.id)

                            scope.showPopper = function () {
                                if (scope[`${floatingDom.id}Show`]) {
                                    return;
                                }
                                scope[`${floatingDom.id}Show`] = true
                                floatingDom.style.display = 'block';
                                floating.computePosition(scope, target, floatingDom)

                            }
                            /**
                             * 自动更新布局的
                             */
                            scope.showAutoUpdatePopper = function () {
                                if (scope[`${floatingDom.id}Show`]) {
                                    return;
                                }
                                scope[`${floatingDom.id}Show`] = true
                                floatingDom.style.display = 'block';
                                floating.autoUpdateComputePosition(scope, target, floatingDom)

                            }

                            scope.hidePopper = function(){
                                scope[`${floatingDom.id}Show`] = false
                                floatingDom.style.height = '0';
                                setTimeout(function () {
                                    floatingDom.style.display = '';
                                }, 300)
                            }
                        }
                    }
                },
                controller: function ($scope, $element) {
                }
            };
        }])
        .directive('focusInOut', ['uuId', 'floating', function (uuId, floating) {
            return {
                restrict: 'A',
                compile: function () {
                    return {
                        post: function (scope, element, attr) {

                            document.addEventListener('click', function(e) {
                                scope.$emit('focusOut', e)
                            });
                        }
                    }
                },
            };
        }])
    ;


    app
        .factory('slot', ['$compile', function ($compile) {
            return {
                replace: function (scope, element, transcludeFn) {
                    transcludeFn(scope, function (clone) {
                        scope.$slot = {}
                        if (!clone) {
                            return
                        }
                        // scope.$slot.hasSlot = true
                        scope.$slot.slotSet = new Set()
                        // debugger

                        let slotMap = new Map();
                        for (let e of clone) {
                            if (!angular.isFunction(e.getAttribute)) {
                                continue;
                            }
                            let slotName = e.getAttribute('slot-name')
                            slotMap.set(slotName, e);
                            scope.$slot.slotSet.add(slotName)
                        }

                        let slotList = element[0].querySelectorAll("slot")
                        if (!slotList || slotList.length === 0) {
                            return;
                        }
                        // console.log(slotList)
                        for (innerSlot of slotList) {
                            // 获取组件内部的插槽
                            let slotName = innerSlot.getAttribute('name')
                            if (!slotName || slotName.length === 0) {
                                return
                            }
                            // 根据名称获取外部传入的插槽
                            let slot = slotMap.get(slotName)
                            if (!slot) {
                                continue;
                            }
                            slot = $compile(slot)(scope)[0];
                            innerSlot.parentNode.replaceChild(slot, innerSlot);
                        }
                    })
                },
                appendChild: function (scope, element, childElement) {
                    if (null == element) {
                        return
                    }
                    element.appendChild($compile(childElement)(scope)[0])
                }
            }
        }])
        .factory('attrHelp', [function () {
            return {
                expose: function (ctrl, attrs) {
                    for (let k of Object.keys(attrs)) {
                        if (k.indexOf("$") >= 0) {
                            continue;
                        }
                        if (k.startsWith('ng')) {
                            continue
                        }
                        // 获取属性值
                        if (BOOLEAN_CUSTOM_ATTR.has(k)) {
                            ctrl[k] = !!attrs[k]
                        }
                        // if ("" === v) {
                        //     scope.$attrs[k] = true
                        // } else {
                        //     scope.$attrs[k] = attrs[k]
                        // }
                    }
                }
            }
        }])
        .factory('uuId', [function () {
            return {
                generate: function getUuid() {
                    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                        var r = Math.random() * 16 | 0,
                            v = c == 'x' ? r : (r & 0x3 | 0x8);
                        return v.toString(16);
                    });
                }
            }
        }])
        .factory('floating', function () {
            // 箭头class
            const arrowClassStyle = ['top','right','bottom','left']

            function setFloatingWidth(scope, target, floating) {
                const {width: targetWidth} = target.getBoundingClientRect()
                // console.log(targetWidth)
                floating.style.minWidth = targetWidth + 'px';
            }
            function setFloatingHeight(scope, target, floating) {
                floating.style.height = 'auto';
                const {height} = floating.getBoundingClientRect()
                floating.style.height = 0;
                floating.offsetHeight
                floating.style.height = (height > 200 ? 200 : height) + 'px';
            }
            function computePosition(scope, target, floating, autoUpdate) {
                // 获取箭头元素
                let arrowElement = floating.querySelector('.mob-popper__arrow');
                window.FloatingUIDOM.computePosition(target, floating, {
                        placement: 'bottom-start',
                        middleware: [
                            window.FloatingUIDOM.flip(),// y轴自适应
                            window.FloatingUIDOM.shift(), // x轴自适应
                            window.FloatingUIDOM.offset(5), // 与目标组件的  空隙
                            window.FloatingUIDOM.arrow({element: arrowElement}), // 箭头

                        ]
                    }
                ).then(({x, y, placement, middlewareData}) => {
                    // console.log(x, y)
                    Object.assign(floating.style, {
                        left: `${x}px`,
                        top: `${y}px`,
                    });

                    const {x: arrowX, y: arrowY} = middlewareData.arrow;

                    debugger
                    const staticSide = {
                        top: 'bottom',
                        right: 'left',
                        bottom: 'top',
                        left: 'right',
                    }[placement.split('-')[0]];

                    const classStyle = {
                        top: 'bottom',
                        right: 'left',
                        bottom: 'top',
                        left: 'right',
                    }[placement.split('-')[0]];

                    angular.forEach(arrowClassStyle, function (v) {
                        arrowElement.classList.remove(v)
                    })
                    arrowElement.classList.add(classStyle)

                    Object.assign(arrowElement.style, {
                        left: arrowX != null ? `${arrowX}px` : '',
                        top: arrowY != null ? `${arrowY}px` : '',
                        right: '',
                        bottom: '',
                        [staticSide]: '0px',
                    });
                    if (!autoUpdate) {
                        setFloatingHeight(scope, target, floating)
                    }
                });
            }
            return {
                computePosition: function (scope, target, floating) {
                    setFloatingWidth(scope, target, floating)
                },

                autoUpdateComputePosition: function (scope, target, floating) {
                    setFloatingWidth(scope, target, floating)
                    setFloatingHeight(scope, target, floating)
                    return window.FloatingUIDOM.autoUpdate(
                        target,
                        floating,
                        ()=>{computePosition(scope, target, floating, true)}
                    );
                }
            };
        })
    ;

    // FIXME 待完善
    app
        .component('mobPopper', { // FIXME 待完善
            transclude: true,
            templateUrl: './components/mob-popper.html',
            bindings: {
                show: '<?'
            },
            controller: function ($scope, $element) {
                // 初始化工作
                this.$onInit = function () {
                }


                this.$onChanges = function (changes) {

                }

                this.$onDestroy = function () {
                }

                this.$postLink = function () {
                }
            }
        })

        .component('mobForm', {// https://segmentfault.com/a/1190000005868488
            transclude: true,
            templateUrl: './components/mob-form.html',
            bindings: {
                model: '=',
                formItem: '<'
            },
            controller: function () {
                this.$onInit = function () {
                }
            }
        })
        .component('mobFormItem', {
            transclude: true,
            templateUrl: './components/mob-form-item.html',
            bindings: {
                model: '=',
                label: '<',
                prop: '<'
            },
            controller: function () {
                this.generateUuid = function () {
                    return Math.random().toString(36).slice(2); // 截取小数点后的字符串
                }

                this.$onInit = function () {
                    this.uuid = this.generateUuid()
                }
            }
        })
        .component('mobInput', {
            transclude: true,
            templateUrl: './components/mob-input.html',
            bindings: {
                ngModel: '=?',
                ngDisabled: '<?',
                placeholder: '<?',
                prefixIcon: '<?',
                suffixIcon: '<?',
                clearable: '<?',
                showPassword: '<?',
                ngMaxlength: '<?',
                showWordLimit: '<?',
                handleChange: '&'
            },
            controller: function ($scope, $element, $transclude, $attrs, $compile, slot) {
                // 初始化工作
                this.$onInit = function () {
                    if (angular.isUndefined(this.placeholder)) {
                        this.placeholder = '请输入内容'
                    }
                    // 动态插槽实现
                    slot.replace($scope, $element, $transclude)
                    // 通过class配置icon
                    compilePrefix(this.prefixIcon);
                    compileSuffix(this.suffixIcon);

                    if (this.showPassword) {
                        $scope.valueVisiable = false // 默认为不展示明文
                    }
                }


                function compilePrefix(icon) {
                    if (!icon) {
                        return;
                    }
                    let prefixInner = $element[0].querySelector('.mob-input__prefix-inner')
                    slot.appendChild($scope, prefixInner, `<${icon}></${icon}>`)
                }

                function compileSuffix(icon) {
                    if (!icon) {
                        return;
                    }
                    let inner = $element[0].querySelector('.mob-input__suffix-inner')
                    slot.appendChild($scope, inner, `<${icon}></${icon}>`)
                }


                this.$onChanges = function (changes) {
                }

                this.$onDestroy = function () {
                }


                this.$postLink = function () {
                }


                /**
                 * input聚焦
                 */
                this.focus = function () {
                    let input = $element[0].querySelector('.mob-input__inner')
                    input.focus();
                }

                /**
                 * 清空input内容
                 */
                this.clean = function () {
                    this.focus()
                    this.ngModel = ''
                }

                /**
                 * 点击可视按钮
                 */
                this.visibleClickHandle = function () {
                    this.focus()
                    let input = $element[0].querySelector('.mob-input__inner')
                    if ($scope.valueVisiable) {
                        input.type = 'password'
                    } else {
                        input.type = 'text'
                    }
                    $scope.valueVisiable = !$scope.valueVisiable
                }

                // 是否显示清除按钮
                this.showClear = function () {
                    return this.clearable &&
                        !this.ngDisabled &&
                        this.ngModel && this.ngModel.length > 0
                }
                // 是否显示可视按钮
                this.showValueAccessVisible = function () {
                    return this.showPassword &&
                        !this.ngDisabled &&
                        this.ngModel &&
                        this.ngModel.length > 0 &&
                        $scope.valueVisiable
                }
                // 是否显示不可视按钮
                this.showValueInVisible = function () {
                    return this.showPassword &&
                        !this.ngDisabled &&
                        this.ngModel &&
                        this.ngModel.length > 0 &&
                        !$scope.valueVisiable
                }


                /**
                 * 是否显示字数统计
                 */
                this.showWordCount = function () {
                    return this.showWordLimit && !this.showPassword
                }
            }
        })
        .component('mobInputNumber', {
            transclude: true,
            templateUrl: './components/mob-input-number.html',
            bindings: {
                ngModel: '=?',
                ngDisabled: '<?',
                step: '<?',
                stepStrictly: '<?',
                precision: '<?',
                min: '<?',
                max: '<?',
                changeEvent: '&?',
                blurEvent: '&?'
            },
            controller: function ($scope, $element, $transclude, $attrs, $compile, slot) {
                // 初始化工作
                this.$onInit = function () {
                    // 动态插槽实现
                    slot.replace($scope, $element, $transclude)
                    // 获取步长
                    this.calculateStep();
                }

                this.calculateStep = function () {
                    // 未定义步长，默认为1
                    if (angular.isUndefined(this.step)) {
                        if (angular.isUndefined(this.precision)) {
                            this.step = 1;
                        } else {
                            this.step = 1 / Math.pow(10, this.precision);
                        }
                    }
                }


                this.$onChanges = function (changes) {
                }

                this.$onDestroy = function () {
                }


                this.$postLink = function () {
                }


                /**
                 * input聚焦
                 */
                this.focus = function () {
                    let input = $element[0].querySelector('.mob-input__inner')
                    input.focus();
                }

                /**
                 * 清空input内容
                 */
                this.clean = function () {
                    this.focus()
                    this.ngModel = ''
                }

                // 按照指定精度转换ngModel
                this.patternPrecision = function (ngModel) {
                    debugger
                    let temporaryNgModel = ngModel.toNumber()
                    // 防止越界
                    let step = new Decimal(this.step)
                    // 判断是否小于最小值
                    if (angular.isDefined(this.min) && temporaryNgModel < this.min) {
                        ngModel = ngModel.add(step)
                    }
                    // 判断是否大于最大值
                    if (angular.isDefined(this.max) && temporaryNgModel > this.max) {
                        ngModel = ngModel.minus(step)
                    }
                    // 按照精度转换为Number
                    if (angular.isUndefined(this.precision)) {
                        this.ngModel = ngModel.toNumber();
                    } else {
                        this.ngModel = ngModel.toFixed(this.precision).toNumber();
                    }
                }

                // 步长模式
                this.patternStep = function () {
                    let ngModel = new Decimal(this.ngModel)
                    let step = new Decimal(this.step)
                    let mod = ngModel.mod(step)

                    if (this.stepStrictly) {
                        ngModel = ngModel.minus(mod)
                    }

                    mod = mod.mul(new Decimal(2))
                    if (mod > step) {
                        ngModel = ngModel.add(step)
                    }

                    this.ngModel = ngModel.toNumber()
                }

                /**
                 * 减少
                 */
                this.decrease = function () {
                    if (this.ngDisabled) {
                        return
                    }
                    this.patternStep()
                    let ngModel = new Decimal(this.ngModel).minus(new Decimal(this.step))
                    this.patternPrecision(ngModel)
                }

                /**
                 * 增加
                 */
                this.increase = function () {
                    if (this.ngDisabled) {
                        return
                    }
                    this.patternStep()
                    let ngModel = new Decimal(this.ngModel).add(new Decimal(this.step))
                    this.patternPrecision(ngModel)
                }

                /**
                 * model改变时的回调
                 */
                this.changeHandle = function () {
                    if (angular.isFunction(this.changeEvent)) {
                        this.changeEvent(this.ngModel)
                    }
                }
                /**
                 * 失焦
                 */
                this.blurHandle = function () {
                    debugger
                    this.patternStep()
                    this.patternPrecision(new Decimal(this.ngModel))
                    if (angular.isFunction(this.blurEvent)) {
                        this.blurEvent(this.ngModel)
                    }
                }

            }
        })
        .component('mobSelect', {
            transclude:true,
            templateUrl: './components/mob-select.html',
            bindings: {
                ngModel: '=?',
                placeHolder: '<?',
                changeHandle: '&?'
            },
            controller: function ($scope, $element, uuId, floating) {
                // 初始化工作
                this.$onInit = function () {
                    if (angular.isUndefined(this.placeHolder)) {
                        this.placeHolder = '请选择'
                    }
                    this.name = `mobSelect_${$scope.$id}`
                }


                this.$onChanges = function (changes) {}

                this.$onDestroy = function () {}


                this.$postLink = function () {
                    this.initEvent()
                }

                this.clickHandler = function () {
                    let target = $element[0].querySelector('.mob_popper__target');
                    let popperId = target.getAttribute('popper-id')

                    if ($scope[`${popperId}Show`]) {
                        $scope.hidePopper()
                    } else {
                        $scope.showAutoUpdatePopper()
                        $scope.showPopper()
                        this.onFocus()
                    }
                }

                this.onFocus = function () {
                    let selectSection = $element[0].querySelector('.mob-select__selection')
                    selectSection.querySelector('input').focus()
                }

                const _that = this
                this.initEvent = function(){
                    // 点击select外部的时候，隐藏下拉框
                    $scope.$on('focusOut', function (e, originEvent) {
                        if ($element[0].contains(originEvent.target)) {
                            _that.onFocus()
                            originEvent.preventDefault()
                            originEvent.stopPropagation()
                            return
                        }
                        $scope.hidePopper()
                    })

                    // 监听optionsClick事件
                    $scope.$on('selectOptionsClick', function (e, data) {
                        _that.ngModel = data
                        _that.placeHolder = data
                        $scope.hidePopper()
                        // 反向通知group下所有的radio绑定的ngModel
                        $scope.$broadcast(`${_that.name}Change`, _that.ngModel)
                    })
                }
            }
        })
        .component('mobSelectOptions', {
            transclude:true,
            templateUrl: './components/mob-select-options.html',
            require: {
                'mobSelect': '?^mobSelect'
            },
            bindings: {
                label: '<?',
                value: '<?'
            },
            controller: function ($scope, $element, uuId, floating) {
                // 初始化工作
                this.$onInit = function () {
                    $scope.active = false

                    const _that = this
                    this.name = this.mobSelect.name
                    // 监听父组件的通知事件
                    $scope.$on(`${_that.name}Change`, function (e, data) {
                        if (Array.isArray(data)) {
                            $scope.active = data.includes(_that.getValue())
                        } else {
                            $scope.active = data === _that.getValue()
                        }
                    })
                }

                this.$onChanges = function (changes) {}

                this.$onDestroy = function () {}

                this.$postLink = function () {}

                // 获取options的Value
                this.getValue = function (){
                    // 优先取value，然后是label
                    return this.value ? this.value : this.label
                }
                // options的点击事件，被点击时，通知父组件
                this.clickHandler = function () {
                    $scope.active = !$scope.active
                    let val = this.getValue()
                    $scope.$emit('selectOptionsClick', val)
                }
            }
        })
        .component('mobRadio', {
            templateUrl: './components/mob-radio.html',
            require: {
                'radioGroup': '?^mobRadioGroup'
            },
            bindings: {
                ngModel: '=?',
                ngDisabled: '<?',
                name: '<?',
                label: '<',
                value: '<?',
                border: '<?',
                changeHandle: '&?'
            },
            controller: function ($scope, $element, $attrs) {
                // 初始化工作
                this.$onInit = function () {
                    if (!this.value) {
                        this.value = this.label
                    }

                    if (!angular.isUndefined(this.radioGroup) && this.radioGroup !== null) {
                        // 绑定model
                        this.ngModel = this.radioGroup.ngModel
                        // 绑定name，一个组内的radio应该互斥
                        this.name = this.radioGroup.name

                        const _that = this
                        $scope.$on(`${this.name}Change`, function (event, data) {
                            _that.ngModel = data
                        })
                    }
                }


                this.$onChanges = function (changes) {

                }

                this.$onDestroy = function () {

                }


                this.$postLink = function () {
                }

                // 点击事件
                this.clickHandle = function () {
                    debugger
                    if (this.ngDisabled) {
                        return
                    }
                    if (this.ngModel === this.value) {
                        return;
                    }
                    this.change()

                }

                this.change = function () {
                    this.ngModel = this.value
                    if (angular.isFunction(this.changeHandle)) {
                        this.changeHandle({value: this.value})
                    } else {
                        $scope.$emit(`${this.name}ChildChange`, this.value)
                    }

                }
            }
        })
        .component('mobRadioButton', {
            templateUrl: './components/mob-radio-button.html',
            require: {
                'radioGroup': '?^mobRadioGroup'
            },
            bindings: {
                ngModel: '=?',
                ngDisabled: '<?',
                name: '<?',
                label: '<?',
                value: '<?',
                changeHandle: '&?'
            },
            controller: function ($scope, $element, $attrs) {
                // 初始化工作
                this.$onInit = function () {
                    if (!angular.isUndefined(this.radioGroup) && this.radioGroup !== null) {
                        // 绑定model
                        this.ngModel = this.radioGroup.ngModel
                        // 绑定name，一个组内的radio应该互斥
                        this.name = this.radioGroup.name

                        const _that = this
                        $scope.$on(`${this.name}Change`, function (event, data) {
                            _that.ngModel = data
                        })
                    }
                }


                this.$onChanges = function (changes) {

                }

                this.$onDestroy = function () {

                }


                this.$postLink = function () {
                }

                // 点击事件
                this.clickHandle = function () {
                    if (this.ngDisabled) {
                        return
                    }
                    if (this.ngModel === this.value) {
                        return;
                    }
                    this.change()

                }

                this.change = function () {
                    this.ngModel = this.value
                    if (angular.isFunction(this.changeHandle)) {
                        this.changeHandle({value: this.value})
                    } else {
                        $scope.$emit(`${this.name}ChildChange`, this.value)
                    }

                }
            }
        })
        .component('mobRadioGroup', {
            transclude: true,
            templateUrl: './components/mob-radio-group.html',
            bindings: {
                ngModel: '=?',
                listener: '<?',
                changeHandle: '&?'
            },
            controller: function ($scope, $element, $attrs, attrHelp) {
                // 初始化工作
                this.$onInit = function () {
                    this.name = `mobRadioGroup_${$scope.$id}`
                    this.initEvent()
                }


                this.$onChanges = function (changes) {
                    if (changes.listener) {
                        this.change()
                    }
                }

                this.$onDestroy = function () {

                }


                this.$postLink = function () {
                    attrHelp.expose($scope, $attrs)
                }

                this.initEvent = function () {
                    const _that = this
                    $scope.$on(`${_that.name}ChildChange`, function (event, data) {
                        _that.ngModel = data
                        _that.change()
                    })
                }

                this.change = function () {
                    if (angular.isFunction(this.changeHandle)) {
                        this.changeHandle({value: this.ngModel})
                    }
                    // 反向通知group下所有的radio绑定的ngModel
                    $scope.$broadcast(`${this.name}Change`, this.ngModel)
                }
            }
        })
        .component('mobCheckbox', {
            transclude: true,
            templateUrl: './components/mob-checkbox.html',
            require: {
                'checkBoxGroup': '?^mobCheckboxGroup'
            },
            bindings: {
                ngModel: '=?',
                ngDisabled: '<?',
                name: '<?',
                label: '<?',
                value: '<?',
                border: '<?',
                indeterminate: '<?',
                changeHandle: '&?'
            },
            controller: function ($scope, $element, $attrs) {
                // 初始化工作
                this.$onInit = function () {
                    if (!this.value) {
                        this.value = this.label
                    }
                }


                this.$onChanges = function (changes) {
                }

                this.$onDestroy = function () {
                }


                this.$postLink = function () {
                    this.initValue()
                }

                // 初始化Value，以及绑定checkbox的change事件
                this.initValue = function () {
                    if (!angular.isUndefined(this.checkBoxGroup) && this.checkBoxGroup !== null) {
                        // 绑定model
                        if (this.checkBoxGroup && this.checkBoxGroup.ngModel) {
                            this.ngModel = this.checkBoxGroup.ngModel.includes(this.value)
                        }
                        // 绑定name
                        $attrs.name = this.checkBoxGroup.name

                        const _that = this
                        // 监听多选框组的value的Change事件
                        $scope.$on(`${$attrs.name}Change`, function (event, data) {
                            // 判断组内是否包含自己
                            _that.ngModel = data.includes(_that.value)
                        })
                    }
                }

                // 点击事件
                this.clickHandle = function () {
                    if (this.ngDisabled) {
                        return
                    }
                    this.change()

                }

                this.change = function () {
                    this.ngModel = !this.ngModel
                    if (angular.isFunction(this.changeHandle)) {
                        this.changeHandle({value: this.value})
                    } else {
                        $scope.$emit(`${$attrs.name}ChildChange`, this.value)
                    }

                }
            }
        })
        .component('mobCheckboxButton', {
            transclude: true,
            templateUrl: './components/mob-checkbox-button.html',
            require: {
                'checkBoxGroup': '?^mobCheckboxGroup'
            },
            bindings: {
                ngModel: '=?',
                ngDisabled: '<?',
                name: '<?',
                label: '<?',
                value: '<?',
                indeterminate: '<?',
                changeHandle: '&?'
            },
            controller: function ($scope, $element, $attrs) {
                // 初始化工作
                this.$onInit = function () {
                    if (!this.value) {
                        this.value = this.label
                    }
                }


                this.$onChanges = function (changes) {
                }

                this.$onDestroy = function () {
                }


                this.$postLink = function () {
                    this.initValue()
                }

                // 初始化Value，以及绑定checkbox的change事件
                this.initValue = function () {
                    if (!angular.isUndefined(this.checkBoxGroup) && this.checkBoxGroup !== null) {
                        // 绑定model
                        if (this.checkBoxGroup && this.checkBoxGroup.ngModel) {
                            this.ngModel = this.checkBoxGroup.ngModel.includes(this.value)
                        }
                        // 绑定name
                        $attrs.name = this.checkBoxGroup.name

                        const _that = this
                        // 监听多选框组的value的Change事件
                        $scope.$on(`${$attrs.name}Change`, function (event, data) {
                            // 判断组内是否包含自己
                            _that.ngModel = data.includes(_that.value)
                        })
                    }
                }

                // 点击事件
                this.clickHandle = function () {
                    if (this.ngDisabled) {
                        return
                    }
                    this.change()

                }

                this.change = function () {
                    this.ngModel = !this.ngModel
                    if (angular.isFunction(this.changeHandle)) {
                        this.changeHandle({value: this.value})
                    } else {
                        $scope.$emit(`${$attrs.name}ChildChange`, this.value)
                    }

                }
            }
        })
        .component('mobCheckboxGroup', {
            transclude: true,
            templateUrl: './components/mob-checkbox-group.html',
            bindings: {
                ngModel: '=?',// 使用单项的model，用于监听他的change，checkBox
                listener: '<?',// 使用单项的model，用于监听他的change，checkBox
                min: '<?',
                max: '<?',
                changeHandle: '&?'
            },
            controller: function ($scope, $element, $attrs) {
                // 初始化工作
                this.$onInit = function () {
                    if (!this.ngModel) {
                        this.ngModel = []
                    }
                    this.name = `mobCheckBoxGroup_${$scope.$id}`
                    // 创建事件订阅与监听
                    initEvent()
                }

                this.$onChanges = function (changes) {
                    if (changes.listener) {
                        this.change()
                    }
                }

                this.$onDestroy = function () {
                }


                this.$postLink = function () {
                }

                // ngModel改变时，同时子组件
                this.change = function () {
                    if (angular.isFunction(this.changeHandle)) {
                        this.changeHandle({value: this.ngModel})
                    }
                    // 反向通知group下所有的radio绑定的ngModel
                    $scope.$broadcast(`${this.name}Change`, this.ngModel)
                }


                const _that = this

                /**
                 * 初始化事件监听
                 */
                function initEvent() {
                    // 监听子组件的change事件
                    $scope.$on(`${_that.name}ChildChange`, function (event, data) {
                        if (_that.ngModel.includes(data)) {
                            debugger
                            let undefinedMin = angular.isUndefined(_that.min)
                            let definedMin = angular.isDefined(_that.min)
                            if (undefinedMin || definedMin && _that.ngModel.length > _that.min) {
                                _that.ngModel.splice(_that.ngModel.indexOf(data), 1)
                            }
                        } else {
                            let undefinedMax = angular.isUndefined(_that.max)
                            let definedMax = angular.isDefined(_that.max)
                            if (undefinedMax || definedMax && _that.ngModel.length < _that.max) {
                                _that.ngModel.push(data);
                            }
                        }
                        _that.change()
                    })
                }
            }
        })

    ;


    app
        .component('mobDivider', {
            transclude: true,
            templateUrl: './components/mob-divider.html',
            bindings: {
                horizontal: '<?',
                vertical: '<?',
                borderStyle: '<'
            },
            controller: function ($scope) {
                this.$onInit = function () {
                    if (angular.isUndefined(this.horizontal)) {
                        this.horizontal = true;
                    }
                }
            }
        })
        .component('mobIcon', {
            transclude: true,
            templateUrl: './components/mob-icon.html',
            bindings: {},
            controller: function ($scope) {
                // 初始化工作
                this.$onInit = function () {
                }


                this.$onChanges = function (changes) {

                }

                this.$onDestroy = function () {

                }


                this.$postLink = function () {
                }

                this.onFocus = function () {
                    $scope.isFocus = true;

                }
            }
        })
        .component('mobIconDownArrow', {
            templateUrl: './icon/downArrow.html',
        })
        .component('mobIconCircleClose', {
            templateUrl: './icon/circleClose.html',
        })
        .component('mobIconVisible', {
            templateUrl: './icon/visible.html',
        })
        .component('mobIconInvisible', {
            templateUrl: './icon/invisible.html',
        })
        .component('mobIconCalendar', {
            templateUrl: './icon/calendar.html',
        })
        .component('mobIconSearch', {
            templateUrl: './icon/search.html',
        })
        .component('mobIconIncrease', {
            templateUrl: './icon/increase.html',
        })
        .component('mobIconDecrease', {
            templateUrl: './icon/decrease.html',
        })
    ;
    </script>

    </html>
